<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Company Inventory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .navbar-brand { font-weight: bold; }
        .table-responsive { max-height: 70vh; overflow-y: auto; }
        .admin-only { display: none; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Construction Inventory</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3" id="userInfo"></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1 class="mb-4">Inventory Management</h1>

        <!-- Location Filter -->
        <div class="mb-3">
            <label class="form-label">Filter by Location:</label>
            <div id="locationFilters" class="btn-group" role="group">
                <input type="radio" class="btn-check" name="locationFilter" id="allLocations" autocomplete="off" checked>
                <label class="btn btn-outline-primary" for="allLocations">All Locations</label>
            </div>
        </div>

        <!-- Items Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Inventory Items</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="itemsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Supplier</th>
                                <th>Quantity</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Admin Only Sections -->
        <div class="admin-only mt-4">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Add New Item</h5>
                        </div>
                        <div class="card-body">
                            <form id="addItemForm">
                                <div class="mb-3">
                                    <label class="form-label">Name</label>
                                    <input type="text" class="form-control" id="itemName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="itemDescription"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Category</label>
                                        <select class="form-select" id="itemCategory" required></select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Supplier</label>
                                        <select class="form-select" id="itemSupplier" required></select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Quantity</label>
                                        <input type="number" class="form-control" id="itemQuantity" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Location</label>
                                        <select class="form-select" id="itemLocation" required></select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">Add Item</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Add New Location</h5>
                        </div>
                        <div class="card-body">
                            <form id="addLocationForm">
                                <div class="mb-3">
                                    <label class="form-label">Location Name</label>
                                    <input type="text" class="form-control" id="locationName" required>
                                </div>
                                <button type="submit" class="btn btn-success">Add Location</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let user = null;
        let allItems = [];
        let allLocations = [];

        // Check authentication
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
        }

        // Load user info
        fetch('/api/auth/profile', {
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(response => response.json())
        .then(data => {
            user = data.user;
            document.getElementById('userInfo').textContent = `Welcome, ${user.username} (${user.role})`;
            if (user.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
            }
            loadData();
        })
        .catch(() => {
            localStorage.removeItem('token');
            window.location.href = '/login';
        });

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        function loadData() {
            Promise.all([
                fetch('/api/items', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
                fetch('/api/locations', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
                fetch('/api/categories', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
                fetch('/api/suppliers', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json())
            ]).then(([items, locations, categories, suppliers]) => {
                allItems = items;
                allLocations = locations;
                displayItems();
                setupLocationFilters();
                populateSelects(categories, suppliers, locations);
            });
        }

        function displayItems() {
            const tbody = document.querySelector('#itemsTable tbody');
            tbody.innerHTML = '';

            const filteredItems = getFilteredItems();

            filteredItems.forEach(item => {
                const row = tbody.insertRow();
                const quantityCell = user.role === 'admin'
                    ? `<input type="number" class="form-control" value="${item.quantity}" onchange="updateQuantity(${item.id}, this.value)">`
                    : item.quantity;

                const locationOptions = allLocations.map(loc =>
                    `<option value="${loc.id}" ${loc.name === item.location ? 'selected' : ''}>${loc.name}</option>`
                ).join('');

                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.name}</td>
                    <td>${item.description || ''}</td>
                    <td>${item.category || ''}</td>
                    <td>${item.supplier || ''}</td>
                    <td>${quantityCell}</td>
                    <td>
                        <select class="form-select" onchange="updateLocation(${item.id}, this.value)">
                            ${locationOptions}
                        </select>
                    </td>
                    <td></td>
                `;
            });
        }

        function getFilteredItems() {
            const selectedFilter = document.querySelector('input[name="locationFilter"]:checked');
            if (!selectedFilter || selectedFilter.id === 'allLocations') {
                return allItems;
            }
            const locationName = selectedFilter.nextElementSibling.textContent;
            return allItems.filter(item => item.location === locationName);
        }

        function setupLocationFilters() {
            const container = document.getElementById('locationFilters');
            allLocations.forEach(location => {
                const input = document.createElement('input');
                input.type = 'radio';
                input.className = 'btn-check';
                input.name = 'locationFilter';
                input.id = `location${location.id}`;
                input.autocomplete = 'off';

                const label = document.createElement('label');
                label.className = 'btn btn-outline-primary';
                label.htmlFor = `location${location.id}`;
                label.textContent = location.name;

                container.appendChild(input);
                container.appendChild(label);
            });

            document.querySelectorAll('input[name="locationFilter"]').forEach(input => {
                input.addEventListener('change', displayItems);
            });
        }

        function populateSelects(categories, suppliers, locations) {
            const categorySelect = document.getElementById('itemCategory');
            const supplierSelect = document.getElementById('itemSupplier');
            const locationSelect = document.getElementById('itemLocation');

            categorySelect.innerHTML = '<option value="">Select Category</option>' +
                categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');

            supplierSelect.innerHTML = '<option value="">Select Supplier</option>' +
                suppliers.map(sup => `<option value="${sup.id}">${sup.name}</option>`).join('');

            locationSelect.innerHTML = '<option value="">Select Location</option>' +
                locations.map(loc => `<option value="${loc.id}">${loc.name}</option>`).join('');
        }

        function updateQuantity(id, quantity) {
            fetch(`/api/items/${id}/quantity`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ quantity: parseInt(quantity) })
            });
        }

        function updateLocation(id, location_id) {
            fetch(`/api/items/${id}/location`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ location_id: parseInt(location_id) })
            });
        }

        // Add item form
        document.getElementById('addItemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('itemName').value,
                description: document.getElementById('itemDescription').value,
                category_id: parseInt(document.getElementById('itemCategory').value),
                supplier_id: parseInt(document.getElementById('itemSupplier').value),
                quantity: parseInt(document.getElementById('itemQuantity').value),
                location_id: parseInt(document.getElementById('itemLocation').value)
            };

            try {
                const response = await fetch('/api/items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    loadData();
                    e.target.reset();
                } else {
                    alert('Error adding item');
                }
            } catch (error) {
                alert('Error adding item');
            }
        });

        // Add location form
        document.getElementById('addLocationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('locationName').value;

            try {
                const response = await fetch('/api/locations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name })
                });

                if (response.ok) {
                    loadData();
                    e.target.reset();
                } else {
                    alert('Error adding location');
                }
            } catch (error) {
                alert('Error adding location');
            }
        });
    </script>
</body>
</html>